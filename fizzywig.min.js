(function(a,b){function d(){var a={},b={};return a.on=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){b[a]=b[a]||[],b[a].indexOf(d)===-1&&b[a].push(d)}),a},a.off=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){if(b[a]){var c=b[a].indexOf(d);b[a]=b[a].slice(0,c).concat(b[a].slice(c+1))}}),a},a.emit=function(a,c){a=a.split(/\s+/),c=c||[];var d={};return a.forEach(function(a){b[a]&&(d[a]=[],b[a].forEach(function(b){d[a].push(b.apply(this,c))}))}),d},a.clear=function(){return b={},a},a}function e(a,b){var d={},e,g,h;return typeof a=="string"?e=document.querySelector(a):a instanceof Element&&(e=a),g=e.querySelectorAll("[data-content-editor-command]"),g=Array.prototype.map.apply(g,[function(a){return f(a,d)}]).filter(function(a){return!!a}),d.enable=function(){return g.forEach(function(a){a.enable()}),d},d.disable=function(){return g.forEach(function(a){a.disable()}),d},d.toggleSourceMode=function(){b.toggleSourceMode()},d.isSourceMode=function(){return b.isSourceMode()},d.content=function(){return b},c.emitter.on("click",function(){h=!0}),d.enable()}function f(a,b){var c,d,e,f,h;d=a.getAttribute("data-content-editor-command"),e=a.getAttribute("data-content-editor-value"),f=a.getAttribute("data-content-editor-prompt"),c=e||d;if(g.types.hasOwnProperty(c))return g.create(c,a,d,e,f,b)}function g(a,b,c,d,e){this.node=a,this.command=b,this.value=c,this.prompt=d,this.active=!1,this.toolbar=e,this.nodeTarget=a&&a.nodeName.toLowerCase()==="option"?a.parentElement:a}function j(){g.apply(this,arguments)}function l(){g.apply(this,arguments)}function n(){g.apply(this,arguments)}function p(){g.apply(this,arguments)}function r(){g.apply(this,arguments)}function t(){g.apply(this,arguments)}function v(){g.apply(this,arguments)}function x(){g.apply(this,arguments)}function z(){var b={},c,d,e,f;return typeof rangy!="undefined"?(c=rangy,d=rangy):(c=document,d=a),b.get=function(){return f=d.getSelection(),e=f.rangeCount&&f.getRangeAt(0),e&&e.cloneRange()},b.log=function(){console.log(e)},b.refresh=function(){e&&e.refresh&&e.refresh()},b.restore=function(a){if(!a&&!e||!f)return;e=a||e,f.removeAllRanges(),f.addRange(e)},b.commonAncestor=function(){return e&&e.commonAncestorContainer},b.moveToEnd=function(a){var b=c.createRange();f=d.getSelection();try{b.selectNodeContents(a.lastChild),b.collapse(!1),f.setSingleRange(b)}catch(e){}},b.selectNode=function(a){e&&e.selectNode(a)},b.selectNodeContents=function(a){e&&e.selectNodeContents(a)},b.extractContents=function(a){return e&&e.extractContents(a)},b.surroundContents=function(a){if(!e)return;try{e.surroundContents(a)}catch(b){}},b.insertNode=function(a){if(!e)return;try{e.insertNode(a),e.selectNode(a),e.collapse(!1),f.setSingleRange(e)}catch(b){}},b.collapsed=function(){return e&&e.collapsed},b.startContainer=function(){return e&&e.startContainer},b.endContainer=function(){return e&&e.endContainer},b.collapse=function(a){e&&e.collapse(a)},b}function A(a,b,c,d){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.addEventListener(b,E.apply(this,[c]),d||!1):a.attachEvent&&a.attachEvent("on"+b,E.apply(this,[c]))})}function B(a,b,c){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.removeEventListener(b,E.apply(this,[c])):a.attachEvent&&a.detachEvent("on"+b,E.apply(this,[c]))})}function C(a,b){var c=a.className.split(/\s+/);c.indexOf(b)===-1&&c.push(b),a.className=c.join(" ")}function D(a,b){var c=a.className.split(/\s+/),d=c.indexOf(b);d!==-1&&(c=c.slice(0,d).concat(c.slice(d+1))),a.className=c.join(" ")}function E(b){return function(c){c||(c=a.event);if(!("defaultPrevented"in c)){c.defaultPrevented=!1;var d=c.preventDefault;c.preventDefault=function(){this.defaultPrevented=!0,this.returnValue=!1,d&&d.call(this)}}c.target=c.target||c.srcElement,c.which=c.keyCode||c.charCode,b.apply(this,[c])}}var c;c={version:"0.0.1",grouping:/^BR|P|UL|OL|PRE|BLOCKQUOTE|H[1-6]$/,whitelist:["a","abbr","acronym","address","area","b","bdo","big","blockquote","br","caption","center","cite","code","colgroup","dd","del","dfn","dir","div","dl","dt","em","embed","font","h1","h2","h3","h4","h5","h6","hr","i","iframe","img","ins","kbd","li","map","menu","object","ol","p","param","pre","q","s","samp","small","span","strike","strong","sub","sup","table","tbody","td","tfoot","th","thead","tr","tt","u","ul","var"],os:{lion:navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Mac OS X 10_7")!==-1}},c.emitter=d(),c.content=function(b){function n(a){var b=c.range.commonAncestor();b&&b.nodeType===3&&(b=b.parentNode),(!f.lastChild||f.lastChild.nodeName!=="BR")&&f.appendChild(document.createElement("br"));if(a&&a.which===13){if(!document.queryCommandState("insertunorderedlist")&&!document.queryCommandState("insertorderedlist")&&b&&b.nodeType===1&&/^(P|DIV)$/.test(b.nodeName)){var d=document.createElement("br"),e=rangy.getSelection(),g=e.getRangeAt(0);return g.deleteContents(),g.insertNode(d),g.collapseAfter(d),e.setSingleRange(g),a.preventDefault?(a.stopPropagation(),a.preventDefault()):a.returnValue=!1,!1}b&&b.nodeType===1&&/(H[1-6]|PRE)/.test(b.nodeName)&&setTimeout(function(){var b=rangy.getSelection(),c=b.getRangeAt(0);if(c.commonAncestorContainer&&c.commonAncestorContainer.nodeType===1&&/^P|DIV$/.test(c.commonAncestorContainer.nodeName)){while(c.commonAncestorContainer.firstChild)c.insertNode(c.commonAncestorContainer.firstChild),c.commonAncestorContainer.removeChild(c.commonAncestorContainer.firstChild);c.commonAncestorContainer.parentNode.removeChild(c.commonAncestorContainer),c.collapse(!1),b.setSingleRange(c),a.preventDefault?(a.stopPropagation(),a.preventDefault()):a.returnValue=!1}},1)}}function o(b){var d=rangy.saveSelection(),e=p(f);a.setTimeout(function(){var a=document.createElement("div");a.innerHTML=c.sanitizer(f.innerHTML.trim(),"paste"),f.innerHTML="";var b=p(a);f.appendChild(e);var g=rangy.getSelection();rangy.restoreSelection(d),g.deleteFromDocument();var h=b.lastChild,i=g.getRangeAt(0);i.insertNode(b),i.collapseAfter(h),rangy.getSelection().setSingleRange(i)},1)}function p(a){var b=document.createDocumentFragment(),c;while(c=a.firstChild)b.appendChild(c);return b}function q(a){c.range.get(),c.emitter.emit(a.type,[a])}function r(a,b){var c;return function(){function f(){a.apply(e,d),c=null}var d=arguments,e=this;clearTimeout(c),c=setTimeout(f,b)}}function s(){if(h)return;var a=d.json();JSON.stringify(i)!==JSON.stringify(a)&&(c.emitter.emit("dirty"),h=setTimeout(function(){c.emitter.emit("save",[i=d.json()]),h=null},2e3))}var d={},f,g,h,i={},j,k,l,m;return c.emitter.clear(),typeof b=="string"?f=document.querySelector(b):b instanceof Node&&(f=b),j=f.getAttribute("data-content-editable")||"data",l=document.createElement("textarea"),l.setAttribute("style","display:none;"),l.setAttribute("class","fizzy-raw"),f.parentNode.insertBefore(l,f.nextSibling),d.toolbar=function(a){return arguments.length?(g=e(a,d),d):g},d.enable=function(){f.setAttribute("contentEditable",!0);try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBROnReturn",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(a){}return d},d.disable=function(){return f.removeAttribute("contentEditable"),d},d.focus=function(){f.focus()},d.moveToEnd=function(){c.range.moveToEnd(f)},d.json=function(a){var b={},d;return d=((m?l.value:f.innerHTML)||"").trim(),d=c.sanitizer(d,"default"),b[j]=d,b},d.toggleSourceMode=function(){if(d.isSourceMode())c.emitter.emit("toggle:preview"),f.innerHTML=c.sanitizer(l.value.trim(),"default"),l.style.display="none",f.style.display="block",c.emitter.emit("sanitize:preview",[f]),d.moveToEnd(),m=!1;else{var a=f.innerHTML.trim(),b=c.emitter.emit("sanitize:source",[a]);f.style.display="none",l.style.display="block",l.value=c.sanitizer(b["sanitize:source"]&&b["sanitize:source"][0]||a,"default"),c.emitter.emit("toggle:source",[l]),m=!0}},d.isSourceMode=function(){return m},c.emitter.on("keyup change blur paste",s),d.on=c.emitter.on,A(f,"focus blur keyup mouseup paste change",q),A(f,"focus blur keydown mousedown paste change",n),A(f,"paste",o),d.enable()},g.types={insertimage:v,createlink:t,insertunorderedlist:p,insertorderedlist:p,code:r,"<pre>":j,"<p>":l,togglehtml:x};var h=7;while(--h)g.types["<h"+h+">"]=j;["bold","italic","strikethrough","underline","indent","outdent"].forEach(function(a){g.types[a]=n}),g.create=function(a,b,c,d,e,f){var h=new g.types[a](b,c,d,e,f);return h.init()};var i=g.prototype;i.init=function(){var a=this;return c.emitter.on("keyup mouseup paste change",function(){a.check()}),A(this.nodeTarget,"blur",g.emit("blur")),A(this.nodeTarget,"focus",g.emit("focus")),this.isChild()?A(this.nodeTarget,"change",function(b){a.execute(b)}):A(this.node,"click",function(b){a.execute(b)}),this},i.isChild=function(){return this.node!==this.nodeTarget},i.enable=function(){this.nodeTarget.removeAttribute("disabled")},i.disable=function(){this.nodeTarget.setAttribute("disabled","disabled")},i.restoreSelection=function(){this.toolbar.content().focus()},i.activate=function(){this.active?(C(this.nodeTarget,"active"),this.isChild()&&this.node.setAttribute("selected","selected")):(D(this.nodeTarget,"active"),this.isChild()&&this.node.removeAttribute("selected"))},g.emit=function(a){return function(b){c.emitter.emit(a)}},g.block_normalization={normal:"p",heading:"h"},g.block_regexp=/(heading|normal)\s*/i,g.normalizeCommandValue=function(a){return g.block_regexp.test(a)&&(a=a.replace(g.block_regexp,function(a){return g.block_normalization[a.trim().toLowerCase()]})),"<"+a+">"};var k=j.prototype=new g;k.constructor=j,k.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=g.normalizeCommandValue(a),this.active=this.value===a,this.activate()},k.execute=function(a){a.preventDefault(),this.isChild()&&this.nodeTarget.options[this.nodeTarget.selectedIndex].value===this.node.value&&(this.restoreSelection(!0),document.execCommand(this.command,!1,this.value),c.emitter.emit("click change"))};var m=l.prototype=new g;m.constructor=l,m.check=function(){var a,b;try{a=document.queryCommandValue(this.command)}catch(c){}this.active=!a,this.activate()},m.execute=function(a){a.preventDefault();var b=rangy.getSelection(),d=b.getRangeAt(0),e=d.commonAncestorContainer;e&&e.nodeType===3&&(e=e.parentNode,d.selectNode(e));if(e&&e.nodeType===1&&c.grouping.test(e.nodeName)){while(e.firstChild)d.insertNode(e.firstChild),e.firstChild&&e.removeChild(e.firstChild);e.parentNode.removeChild(e),d.collapse(!1),b.setSingleRange(d)}};var o=n.prototype=new g;o.constructor=n,o.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},o.execute=function(a){a.preventDefault(),this.restoreSelection(),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var q=p.prototype=new g;q.constructor=p,q.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},q.execute=function(a){a.preventDefault(),this.restoreSelection(),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var s=r.prototype=new g;s.constructor=r,s.check=function(){var a,b;try{b=c.range.commonAncestor(),a=b&&(b.nodeType===3&&b.parentNode&&b.parentNode.nodeName===this.command.toUpperCase()||b.nodeType===1&&b.nodeName===this.command.toUpperCase())}catch(d){}this.active=a,this.activate()},s.execute=function(a){a.preventDefault();var b,d;this.restoreSelection(),this.check(),this.active?(b=c.range.commonAncestor(),b.nodeType===3&&b.parentNode.nodeName==="CODE"?d=b.parentNode:b.nodeType===1&&b.nodeName==="CODE"&&(d=b),c.range.selectNode(d),c.range.restore(),document.execCommand("removeFormat",!1,null)):(d=document.createElement(this.command),c.range.surroundContents(d)),c.emitter.emit("click change")};var u=t.prototype=new g;u.constructor=t,u.check=function(){var a,b;try{a=c.range.commonAncestor(),b=a&&(a.nodeType===3&&a.parentNode&&a.parentNode.nodeName==="A"||a.nodeType===1&&a.nodeName==="A")}catch(d){}this.active=b,this.activate()},u.execute=function(a){a.preventDefault(),this.restoreSelection();if(this.active)document.execCommand("unlink",!1,null);else{var b=c.emitter.emit(this.prompt);if(b[this.prompt])if(c.range.collapsed()){var d=document.createElement("a");d.innerHTML=b[this.prompt][0],d.setAttribute("href",b[this.prompt][0]),c.range.insertNode(d)}else document.execCommand(this.command,!1,b[this.prompt][0])}c.emitter.emit("click change")};var w=v.prototype=new g;w.constructor=v,w.check=function(){},w.execute=function(a){a.preventDefault(),this.restoreSelection(),c.emitter.emit(this.prompt,[c.range]),c.emitter.emit("click change")};var y=x.prototype=new g;y.constructor=x,y.check=function(){this.active=this.toolbar.isSourceMode(),this.activate()},y.activate=function(){var a=this;i.activate.call(this),this.active?(this.toolbar.disable(),setTimeout(function(){a.enable()},5)):this.toolbar.enable()},y.execute=function(a){a.preventDefault(),this.toolbar.toggleSourceMode(),c.emitter.emit("click change toggle")},c.range=z(),c.sanitizer=function(a,b){return typeof c.sanitizer.policies[b]=="undefined"||typeof html_sanitizer=="undefined"?a:html_sanitizer.sanitizeWithPolicy(a,c.sanitizer.policies[b])},c.sanitizer.policies={},c.sanitizer.policies.paste=function(a,b){if(c.sanitizer.paste_elements.indexOf(a)!==-1)return c.sanitizer.sanitizeAttribs(a,b,c.sanitizer.policies.paste.uri,c.sanitizer.policies.paste.tokens)},c.sanitizer.policies.paste.uri=function(a){return a},c.sanitizer.policies.paste.tokens=function(a,b){return a===html4.atype.STYLE?null:b},c.sanitizer.sanitizeAttribs=function(a,b,d,e){for(var f=0;f<b.length;f+=2){var g=b[f],h=b[f+1],i=null,j=a+"::"+g,k="*::"+g;html4.ATTRIBS.hasOwnProperty(j)?i=html4.ATTRIBS[j]:html4.ATTRIBS.hasOwnProperty(k)?i=html4.ATTRIBS[k]:c.sanitizer.allowed_attributes.hasOwnProperty(j)?i=c.sanitizer.allowed_attributes[j]:c.sanitizer.allowed_attributes.hasOwnProperty(k)&&(i=c.sanitizer.allowed_attributes[k]);if(i!==null)switch(i){case html4.atype.URI:var l=(""+h).match(html_sanitizer.URI_SCHEME_RE);l?!l[1]||html_sanitizer.WHITELISTED_SCHEMES.test(l[1])?h=d?d(h):null:h=null:h=null;break;case html4.atype.URI_FRAGMENT:h&&"#"===h.charAt(0)?(h=h.substring(1),h=e?e(h):h,h!==null&&h!==void 0&&(h="#"+h)):h=null;break;default:h=e?e(i,h):h}else h=null;b[f+1]=h}return b},c.sanitizer.paste_elements=c.whitelist,c.sanitizer.allowed_attributes={"iframe::src":1,"*::data-embed-url":0},a.fizzywig=c})(window);
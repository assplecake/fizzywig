(function(a,b){function d(){var a={},b={};return a.on=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){b[a]=b[a]||[],b[a].indexOf(d)===-1&&b[a].push(d)}),a},a.off=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){if(b[a]){var c=b[a].indexOf(d);b[a]=b[a].slice(0,c).concat(b[a].slice(c+1))}}),a},a.emit=function(a,c){a=a.split(/\s+/),c=c||[];var d={};return a.forEach(function(a){b[a]&&(d[a]=[],b[a].forEach(function(b){d[a].push(b.apply(this,c))}))}),d},a.clear=function(){return b={},a},a}function e(a,b){var d={},e,f,g;return typeof a=="string"?e=document.querySelector(a):a instanceof Element&&(e=a),f=e.querySelectorAll("[data-content-editor-command]"),f=Array.prototype.map.apply(f,[function(a){return h(a,d)}]).filter(function(a){return!!a}),d.enable=function(){return f.forEach(function(a){a.enable()}),d},d.disable=function(){return f.forEach(function(a){a.disable()}),d},d.toggleSourceMode=function(){b.toggleSourceMode()},d.isSourceMode=function(){return b.isSourceMode()},c.emitter.on("focus",function(){g=!0,d.enable()}),c.emitter.on("blur",function(a){g=!1,setTimeout(function(){g||d.disable()},150)}),c.emitter.on("click",function(){g=!0}),d.disable()}function f(a,b){function h(a){c.selection=rangy.getSelection(),c.range=c.selection.rangeCount&&c.selection.getRangeAt(0),i(a)}function i(b){b.which===8&&!(a.innerText||a.textContent||"").trim()&&(b.preventDefault(),a.innerHTML="<p><br></p>");try{var d=c.range.commonAncestorContainer;(!d||(d.nodeType===3||d.nodeName==="DIV")&&d.parentNode===a)&&document.execCommand("formatBlock",!1,"<p>")}catch(b){}}function j(b){setTimeout(function(){a.innerHTML=c.sanitizer(a.innerHTML,"paste")},1)}function k(a){c.emitter.emit(a.type,[a])}function l(a,b){var c;return function(){function f(){a.apply(e,d),c=null}var d=arguments,e=this;clearTimeout(c),c=setTimeout(f,b)}}var d={},e,f,g;return e=a.getAttribute("data-content-editable")||"data",g=document.createElement("textarea"),g.setAttribute("style","display:none;"),g.setAttribute("class","fizzy-raw"),a.parentNode.insertBefore(g,a.nextSibling),d.enable=function(){return a.setAttribute("contentEditable",!0),d},d.disable=function(){return a.removeAttribute("contentEditable"),d},d.focus=function(){return d},d.blur=function(){return d},d.moveToEnd=function(){c.selection=rangy.getSelection(),c.range=rangy.createRange(),c.range.selectNodeContents(a),c.range.collapse(!1),c.selection.setSingleRange(c.range)},d.json=function(){var b={};return B(b,e,(a.innerHTML||"").trim()),b},d.tidy=function(b){b(a),d.sanitize()},d.toggleSourceMode=function(){if(d.isSourceMode())a.innerHTML=c.sanitizer(g.value.trim(),"paste"),g.style.display="none",a.style.display="block",c.emitter.emit("sanitize:preview",[a]);else{var b=a.innerHTML.trim(),e=c.emitter.emit("sanitize:source",[b]);g.value=c.sanitizer(e["sanitize:source"]&&e["sanitize:source"][0]||b,"paste"),a.style.display="none",g.style.display="block"}},d.isSourceMode=function(){return g.style.display!=="none"},d.sanitize=function(){d.isSourceMode()?a.innerHTML=c.sanitizer(a.innerHTML.trim(),"paste"):g.value=c.sanitizer(g.value.trim(),"paste")},C(a,"focus blur keyup mouseup paste change",l(k,50)),C(a,"focus blur keyup mouseup paste change",l(h,50)),C(a,"paste",j),d.enable()}function g(){}function h(a,b){var c,d,e,f,g;d=a.getAttribute("data-content-editor-command"),e=a.getAttribute("data-content-editor-value"),f=a.getAttribute("data-content-editor-prompt"),c=e||d;if(i.types.hasOwnProperty(c))return i.create(c,a,d,e,f,b)}function i(a,b,c,d,e){this.node=a,this.command=b,this.value=c,this.prompt=d,this.active=!1,this.toolbar=e,this.nodeTarget=a&&a.nodeName.toLowerCase()==="option"?a.parentElement:a}function l(){i.apply(this,arguments)}function n(){l.apply(this,arguments)}function p(){i.apply(this,arguments)}function r(){i.apply(this,arguments)}function t(){i.apply(this,arguments)}function v(){i.apply(this,arguments)}function x(){i.apply(this,arguments)}function z(b){var c,d={};return a.getSelection?(c=a.getSelection(),c.rangeCount&&(c=c.getRangeAt(0))):document.selection&&(c=document.selection.createRange()),d.is=function(a){return a.toLowerCase()===d.parentNode()},d.parentNode=function(){var b;if(c)return a.getSelection?(b=c.startContainer,b&&b.nodeType===3&&(b=b.parentNode),b&&b.nodeName.toLowerCase()):c.parentElement().nodeName.toLowerCase()},d.restore=function(e){if(a.getSelection){var f=a.getSelection();b.focus();if(c.collapsed){var g=document.createTextNode("\0");c.insertNode(g),c.selectNode(g),c.collapse(!1)}f.removeAllRanges(),f.addRange(c);if(e){var h=document.createRange(),i=d.commonAncestor();i!==b&&(h.selectNode(i),f.removeAllRanges(),f.addRange(h))}}else document.selection&&c.select&&c.select()},d.commonAncestor=function(){var b;return a.getSelection?(b=c.commonAncestorContainer,b&&b.nodeType===3&&(b=b.parentNode)):document.selection&&(b=c.parentElement()),b},d.selectNode=function(b){var c=document.createRange(),d=a.getSelection();d.removeAllRanges(),c.selectNode(b),d.addRange(c)},d.moveToEnd=function(b){var c,d;document.createRange?(c=document.createRange(),c.selectNodeContents(b),c.collapse(!1),d=a.getSelection(),d.removeAllRanges(),d.addRange(c)):document.selection&&(c=document.createTextRange(),c.moveToElementText(b),c.collapse(!1),c.select())},d.wrap=function(a){var b;try{b=document.createElement(a),c.surroundContents(b),d.selectNode(b)}catch(e){}},d.insertHTML=function(a){if(c&&c.pasteHTML)c.pasteHTML(a);else{var b=document.createElement("div"),d=document.createDocumentFragment(),e,f;b.innerHTML=a;while(e=b.firstChild)f=d.appendChild(e);c.insertNode(d)}},d}function A(){var a=Array.prototype.slice.apply(arguments);return a.reduce(function(a,b){return Object.keys(b).forEach(function(c){a[c]&&a[c].constructor===Object&&b[c].constructor===Object?A(a[c],b[c]):a[c]=b[c]}),a})}function B(a,b,c){function d(a,b,c,d){return a[b]}function e(a,b,d,e){return d===e.length-1?a[b]=c:a[b]||(a[b]={})}return typeof b=="string"&&(b=b.split(".")),b.reduce(typeof c=="undefined"?d:e,a)}function C(a,b,c,d){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.addEventListener(b,G.apply(this,[c]),d||!1):a.attachEvent&&a.attachEvent("on"+b,G.apply(this,[c]))})}function D(a,b,c){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.removeEventListener(b,G.apply(this,[c])):a.attachEvent&&a.detachEvent("on"+b,G.apply(this,[c]))})}function E(a,b){var c=a.className.split(/\s+/);c.indexOf(b)===-1&&c.push(b),a.className=c.join(" ")}function F(a,b){var c=a.className.split(/\s+/),d=c.indexOf(b);d!==-1&&(c=c.slice(0,d).concat(c.slice(d+1))),a.className=c.join(" ")}function G(b){return function(c){c||(c=a.event);if(!("defaultPrevented"in c)){c.defaultPrevented=!1;var d=c.preventDefault;c.preventDefault=function(){this.defaultPrevented=!0,this.returnValue=!1,d&&d.call(this)}}c.target=c.target||c.srcElement,c.which=c.keyCode||c.charCode,b.apply(this,[c])}}var c;c={version:"0.0.1",block_elements:["p","pre","Normal","Preformatted"],inline_elements:["b","i","strong","em","a","del","strike"],void_elements:["img","br","hr"],whitelist:["a","abbr","acronym","address","area","b","bdo","big","blockquote","br","caption","center","cite","code","colgroup","dd","del","dfn","dir","div","dl","dt","em","embed","font","h1","h2","h3","h4","h5","h6","hr","i","img","ins","kbd","li","map","menu","object","ol","p","param","pre","q","s","samp","small","span","strike","strong","sub","sup","table","tbody","td","tfoot","th","thead","tr","tt","u","ul","var"]},[1,2,3,4,5,6].forEach(function(a){c.block_elements.push("Heading "+a),c.block_elements.push("h"+a)}),c.emitter=d(),c.content=function(a){function k(){if(i)return;var a=b.json();JSON.stringify(j)!==JSON.stringify(a)&&(c.emitter.emit("dirty"),i=setTimeout(function(){c.emitter.emit("save",[j=b.json()]),i=null},2e3))}var b={},d,g,h,i,j={};c.emitter.clear();if(typeof a=="string")d=document.querySelectorAll(a);else if(a instanceof NodeList||Array.isArray(a))d=a;return d=Array.prototype.map.apply(d,[function(a){return f(a,b)}]),b.toolbar=function(a){return arguments.length?(g=e(a,b),b):g},b.enable=function(){d.forEach(function(a){a.enable()});try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBROnReturn",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(a){}return b},b.disable=function(){return d.forEach(function(a){a.disable()}),b},b.focus=function(){return d.forEach(function(a){a.focus()}),b},b.blur=function(){return d.forEach(function(a){a.blur()}),b},b.moveToEnd=function(){d[0].moveToEnd()},b.json=function(){var a={},b=d.map(function(a){return a.json()});return b.unshift(a),A.apply(null,b),a},b.tidy=function(a){b.isSourceMode()&&b.toggleSourceMode(),d.forEach(function(b){b.tidy(a)})},b.toggleSourceMode=function(){d.forEach(function(a){a.toggleSourceMode()})},b.isSourceMode=function(){return d.some(function(a){return a.isSourceMode()})},b.sanitize=function(){d.forEach(function(a){a.sanitize()})},c.emitter.on("keyup change blur paste",k),c.emitter.on("focus",function(){b.focus()}),c.emitter.on("blur",function(){b.blur()}),b.on=c.emitter.on,b.enable()},i.types={insertimage:v,createlink:t,code:r,"<pre>":l,"<p>":n,togglehtml:x};var j=7;while(--j)i.types["<h"+j+">"]=l;["insertunorderedlist","insertorderedlist","bold","italic","strikethrough","underline","indent","outdent"].forEach(function(a){i.types[a]=p}),i.create=function(a,b,c,d,e,f){var g=new i.types[a](b,c,d,e,f);return g.init()};var k=i.prototype;k.init=function(){var a=this;return c.emitter.on("keyup mouseup paste change",function(){a.check()}),C(this.nodeTarget,"blur",i.emit("blur")),C(this.nodeTarget,"focus",i.emit("focus")),this.isChild()?C(this.nodeTarget,"change click",function(b){a.execute(b)}):C(this.node,"click",function(b){a.execute(b)}),this},k.isChild=function(){return this.node!==this.nodeTarget},k.enable=function(){this.nodeTarget.removeAttribute("disabled")},k.disable=function(){this.nodeTarget.setAttribute("disabled","disabled")},k.activate=function(){this.active?(E(this.nodeTarget,"active"),this.isChild()&&this.node.setAttribute("selected","selected")):(F(this.nodeTarget,"active"),this.isChild()&&this.node.removeAttribute("selected"))},i.emit=function(a){return function(b){c.emitter.emit(a)}},i.block_normalization={normal:"p",heading:"h"},i.block_regexp=/(heading|normal)\s*/i,i.normalizeCommandValue=function(a){return i.block_regexp.test(a)&&(a=a.replace(i.block_regexp,function(a){return i.block_normalization[a.trim().toLowerCase()]})),"<"+a+">"};var m=l.prototype=new i;m.constructor=l,m.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=i.normalizeCommandValue(a),this.active=this.value===a,this.activate()},m.execute=function(a){a.preventDefault(),this.isChild()&&this.nodeTarget.value===this.node.value&&(g(!0),document.execCommand(this.command,!1,this.value),c.emitter.emit("click change"))};var o=n.prototype=new l;o.constructor=n,o.check=function(){var a,b;try{a=document.queryCommandValue(this.command),b=document.queryCommandState("insertunorderedlist")||document.queryCommandState("insertorderedlist")}catch(c){}a=i.normalizeCommandValue(a),this.active=this.value===a||b,this.activate()};var q=p.prototype=new i;q.constructor=p,q.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},q.execute=function(a){a.preventDefault(),g(),["insertunorderedlist","insertorderedlist"].indexOf(this.command)!==-1&&document.execCommand("formatBlock",!1,"<p>"),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var s=r.prototype=new i;s.constructor=r,s.check=function(){var a,b;try{b=c.range.commonAncestorContainer,a=b&&(b.nodeType===3&&b.parentNode&&b.parentNode.nodeName===this.command.toUpperCase()||b.nodeType===1&&b.nodeName===this.command.toUpperCase())}catch(d){}this.active=a,this.activate()},s.execute=function(a){a.preventDefault();var b,d;g(),this.check(),this.active?(b=c.range.commonAncestorContainer,b.nodeType===3&&b.parentNode.nodeName==="CODE"?d=b.parentNode:b.nodeType===1&&b.nodeName==="CODE"&&(d=b),c.range.selectNode(d),document.execCommand("removeFormat",!1,null)):c.range&&c.range.canSurroundContents()&&(d=document.createElement(this.command),c.range.surroundContents(d)),c.emitter.emit("click change")};var u=t.prototype=new i;u.constructor=t,u.check=function(){var a,b;try{a=c.range.commonAncestorContainer,b=a&&(a.nodeType===3&&a.parentNode&&a.parentNode.nodeName==="A"||a.nodeType===1&&a.nodeName==="A")}catch(d){}this.active=b,this.activate()},u.execute=function(a){a.preventDefault(),g();if(this.active)document.execCommand("unlink",!1,null);else{var b=c.emitter.emit(this.prompt);b[this.prompt]&&document.execCommand(this.command,!1,b[this.prompt][0])}c.emitter.emit("click change")};var w=v.prototype=new i;w.constructor=v,w.check=function(){},w.execute=function(a){a.preventDefault(),g(),c.emitter.emit(this.prompt,[c.range]),c.emitter.emit("click change")};var y=x.prototype=new i;y.constructor=x,y.check=function(){this.active=this.toolbar.isSourceMode(),this.activate()},y.activate=function(){var a=this;k.activate.call(this),this.active?(this.toolbar.disable(),setTimeout(function(){a.enable()},5)):this.toolbar.enable()},y.execute=function(a){a.preventDefault(),this.toolbar.toggleSourceMode(),c.emitter.emit("click change toggle")},c.sanitizer=function(a,b){return typeof html_sanitizer=="undefined"?a:html_sanitizer.sanitizeWithPolicy(a,c.sanitizer.policies[b])},c.sanitizer.policies={paste:function(a,b){if(c.sanitizer.paste_elements.indexOf(a)!==-1)return html_sanitizer.sanitizeAttribs(a,b,c.sanitizer.policies.uri,c.sanitizer.policies.tokens)},uri:function(a){return a},tokens:function(a){return null}},c.sanitizer.paste_elements=c.whitelist,a.fizzywig=c})(window);
(function(a,b){function d(){var a={},b={};return a.on=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){b[a]=b[a]||[],b[a].indexOf(d)===-1&&b[a].push(d)}),a},a.off=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){if(b[a]){var c=b[a].indexOf(d);b[a]=b[a].slice(0,c).concat(b[a].slice(c+1))}}),a},a.emit=function(a,c){a=a.split(/\s+/),c=c||[];var d={};return a.forEach(function(a){b[a]&&(d[a]=[],b[a].forEach(function(b){d[a].push(b.apply(this,c))}))}),d},a.clear=function(){return b={},a},a}function e(a,b){var d={},e,g,h;return typeof a=="string"?e=document.querySelector(a):a instanceof Element&&(e=a),g=e.querySelectorAll("[data-content-editor-command]"),g=Array.prototype.map.apply(g,[function(a){return f(a,d)}]).filter(function(a){return!!a}),d.enable=function(){return g.forEach(function(a){a.enable()}),d},d.disable=function(){return g.forEach(function(a){a.disable()}),d},d.toggleSourceMode=function(){b.toggleSourceMode()},d.isSourceMode=function(){return b.isSourceMode()},d.content=function(){return b},c.emitter.on("click",function(){h=!0}),d.enable()}function f(a,b){var c,d,e,f,h;d=a.getAttribute("data-content-editor-command"),e=a.getAttribute("data-content-editor-value"),f=a.getAttribute("data-content-editor-prompt"),c=e||d;if(g.types.hasOwnProperty(c))return g.create(c,a,d,e,f,b)}function g(a,b,c,d,e){this.node=a,this.command=b,this.value=c,this.prompt=d,this.active=!1,this.toolbar=e,this.nodeTarget=a&&a.nodeName.toLowerCase()==="option"?a.parentElement:a}function j(){g.apply(this,arguments)}function l(){j.apply(this,arguments)}function n(){g.apply(this,arguments)}function p(){g.apply(this,arguments)}function r(){g.apply(this,arguments)}function t(){g.apply(this,arguments)}function v(){g.apply(this,arguments)}function x(){var b={},c,d,e,f;return typeof rangy!="undefined"?(c=rangy,d=rangy):(c=document,d=a),b.get=function(){f=d.getSelection(),e=f.rangeCount&&f.getRangeAt(0)},b.commonAncestor=function(){return e&&e.commonAncestorContainer},b.moveToEnd=function(a){var b=c.createRange();f=d.getSelection(),b.selectNodeContents(a),b.collapse(!1),f.setSingleRange(b)},b.selectNode=function(a){e&&e.selectNode(a)},b.surroundContents=function(a){if(!e)return;try{e.surroundContents(a)}catch(b){}},b.insertNode=function(a){if(!e)return;try{e.insertNode(a)}catch(b){}},b.startContainer=function(){return e&&e.startContainer},b}function y(a,b,c,d){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.addEventListener(b,C.apply(this,[c]),d||!1):a.attachEvent&&a.attachEvent("on"+b,C.apply(this,[c]))})}function z(a,b,c){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.removeEventListener(b,C.apply(this,[c])):a.attachEvent&&a.detachEvent("on"+b,C.apply(this,[c]))})}function A(a,b){var c=a.className.split(/\s+/);c.indexOf(b)===-1&&c.push(b),a.className=c.join(" ")}function B(a,b){var c=a.className.split(/\s+/),d=c.indexOf(b);d!==-1&&(c=c.slice(0,d).concat(c.slice(d+1))),a.className=c.join(" ")}function C(b){return function(c){c||(c=a.event);if(!("defaultPrevented"in c)){c.defaultPrevented=!1;var d=c.preventDefault;c.preventDefault=function(){this.defaultPrevented=!0,this.returnValue=!1,d&&d.call(this)}}c.target=c.target||c.srcElement,c.which=c.keyCode||c.charCode,b.apply(this,[c])}}var c;c={version:"0.0.1",grouping:["p","ul","ol","pre","blockquote"],whitelist:["a","abbr","acronym","address","area","b","bdo","big","blockquote","br","caption","center","cite","code","colgroup","dd","del","dfn","dir","div","dl","dt","em","embed","font","h1","h2","h3","h4","h5","h6","hr","i","img","ins","kbd","li","map","menu","object","ol","p","param","pre","q","s","samp","small","span","strike","strong","sub","sup","table","tbody","td","tfoot","th","thead","tr","tt","u","ul","var"]},[1,2,3,4,5,6].forEach(function(a){c.grouping.push("h"+a)}),c.emitter=d(),c.content=function(a){function l(a){c.range.get(),a.which===8&&!(d.innerText||d.textContent||"").trim()&&(a.preventDefault(),d.innerHTML="<p><br></p>");try{var b=c.range.commonAncestor(),e=c.range.startContainer();if(!b||b===d&&e&&e.nodeType===3)document.execCommand("formatBlock",!1,"<p>");else while(b!==d)b.parentNode===d&&(b.nodeType===3||c.grouping.indexOf(b.nodeName.toLowerCase())===-1)&&document.execCommand("formatBlock",!1,"<p>"),b=b.parentNode}catch(a){}}function m(a){setTimeout(function(){d.innerHTML=c.sanitizer(d.innerHTML,"paste")},1)}function n(a){c.emitter.emit(a.type,[a])}function o(a,b){var c;return function(){function f(){a.apply(e,d),c=null}var d=arguments,e=this;clearTimeout(c),c=setTimeout(f,b)}}function p(){if(g)return;var a=b.json();JSON.stringify(h)!==JSON.stringify(a)&&(c.emitter.emit("dirty"),g=setTimeout(function(){c.emitter.emit("save",[h=b.json()]),g=null},2e3))}var b={},d,f,g,h={},i,j,k;return c.emitter.clear(),typeof a=="string"?d=document.querySelector(a):a instanceof Node&&(d=a),i=d.getAttribute("data-content-editable")||"data",k=document.createElement("textarea"),k.setAttribute("style","display:none;"),k.setAttribute("class","fizzy-raw"),d.parentNode.insertBefore(k,d.nextSibling),b.toolbar=function(a){return arguments.length?(f=e(a,b),b):f},b.enable=function(){d.setAttribute("contentEditable",!0);try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBROnReturn",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(a){}return b},b.disable=function(){return d.removeAttribute("contentEditable"),b},b.focus=function(){d.focus()},b.moveToEnd=function(){c.range.moveToEnd(d)},b.json=function(){var a={};return a[i]=(d.innerHTML||"").trim(),a},b.tidy=function(a){b.isSourceMode()&&b.toggleSourceMode(),b.sanitize()},b.toggleSourceMode=function(){if(b.isSourceMode())d.innerHTML=c.sanitizer(k.value.trim(),"paste"),k.style.display="none",d.style.display="block",c.emitter.emit("sanitize:preview",[d]);else{var a=d.innerHTML.trim(),e=c.emitter.emit("sanitize:source",[a]);k.value=c.sanitizer(e["sanitize:source"]&&e["sanitize:source"][0]||a,"paste"),d.style.display="none",k.style.display="block"}},b.isSourceMode=function(){return k.style.display!=="none"},b.sanitize=function(){b.isSourceMode()?d.innerHTML=c.sanitizer(d.innerHTML.trim(),"paste"):k.value=c.sanitizer(k.value.trim(),"paste")},c.emitter.on("keyup change blur paste",p),b.on=c.emitter.on,y(d,"focus blur keyup mouseup paste change",n),y(d,"focus blur keyup mouseup paste change",o(l,50)),y(d,"paste",m),b.enable()},g.types={insertimage:t,createlink:r,code:p,"<pre>":j,"<p>":l,togglehtml:v};var h=7;while(--h)g.types["<h"+h+">"]=j;["insertunorderedlist","insertorderedlist","bold","italic","strikethrough","underline","indent","outdent"].forEach(function(a){g.types[a]=n}),g.create=function(a,b,c,d,e,f){var h=new g.types[a](b,c,d,e,f);return h.init()};var i=g.prototype;i.init=function(){var a=this;return c.emitter.on("keyup mouseup paste change",function(){a.check()}),y(this.nodeTarget,"blur",g.emit("blur")),y(this.nodeTarget,"focus",g.emit("focus")),this.isChild()?y(this.nodeTarget,"change",function(b){a.execute(b)}):y(this.node,"click",function(b){a.execute(b)}),this},i.isChild=function(){return this.node!==this.nodeTarget},i.enable=function(){this.nodeTarget.removeAttribute("disabled")},i.disable=function(){this.nodeTarget.setAttribute("disabled","disabled")},i.restoreSelection=function(){this.toolbar.content().focus()},i.activate=function(){this.active?(A(this.nodeTarget,"active"),this.isChild()&&this.node.setAttribute("selected","selected")):(B(this.nodeTarget,"active"),this.isChild()&&this.node.removeAttribute("selected"))},g.emit=function(a){return function(b){c.emitter.emit(a)}},g.block_normalization={normal:"p",heading:"h"},g.block_regexp=/(heading|normal)\s*/i,g.normalizeCommandValue=function(a){return g.block_regexp.test(a)&&(a=a.replace(g.block_regexp,function(a){return g.block_normalization[a.trim().toLowerCase()]})),"<"+a+">"};var k=j.prototype=new g;k.constructor=j,k.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=g.normalizeCommandValue(a),this.active=this.value===a,this.activate()},k.execute=function(a){a.preventDefault(),this.isChild()&&this.nodeTarget.options[this.nodeTarget.selectedIndex].value===this.node.value&&(this.restoreSelection(!0),document.execCommand(this.command,!1,this.value),c.emitter.emit("click change"))};var m=l.prototype=new j;m.constructor=l,m.check=function(){var a,b;try{a=document.queryCommandValue(this.command),b=document.queryCommandState("insertunorderedlist")||document.queryCommandState("insertorderedlist")}catch(c){}a=g.normalizeCommandValue(a),this.active=this.value===a||b,this.activate()};var o=n.prototype=new g;o.constructor=n,o.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},o.execute=function(a){a.preventDefault(),this.restoreSelection(),["insertunorderedlist","insertorderedlist"].indexOf(this.command)!==-1&&document.execCommand("formatBlock",!1,"<p>"),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var q=p.prototype=new g;q.constructor=p,q.check=function(){var a,b;try{b=c.range.commonAncestor(),a=b&&(b.nodeType===3&&b.parentNode&&b.parentNode.nodeName===this.command.toUpperCase()||b.nodeType===1&&b.nodeName===this.command.toUpperCase())}catch(d){}this.active=a,this.activate()},q.execute=function(a){a.preventDefault();var b,d;this.restoreSelection(),this.check(),this.active?(b=c.range.commonAncestor(),b.nodeType===3&&b.parentNode.nodeName==="CODE"?d=b.parentNode:b.nodeType===1&&b.nodeName==="CODE"&&(d=b),c.range.selectNode(d),document.execCommand("removeFormat",!1,null)):(d=document.createElement(this.command),c.range.surroundContents(d)),c.emitter.emit("click change")};var s=r.prototype=new g;s.constructor=r,s.check=function(){var a,b;try{a=c.range.commonAncestor(),b=a&&(a.nodeType===3&&a.parentNode&&a.parentNode.nodeName==="A"||a.nodeType===1&&a.nodeName==="A")}catch(d){}this.active=b,this.activate()},s.execute=function(a){a.preventDefault(),this.restoreSelection();if(this.active)document.execCommand("unlink",!1,null);else{var b=c.emitter.emit(this.prompt);b[this.prompt]&&document.execCommand(this.command,!1,b[this.prompt][0])}c.emitter.emit("click change")};var u=t.prototype=new g;u.constructor=t,u.check=function(){},u.execute=function(a){a.preventDefault(),this.restoreSelection(),c.emitter.emit(this.prompt,[c.range]),c.emitter.emit("click change")};var w=v.prototype=new g;w.constructor=v,w.check=function(){this.active=this.toolbar.isSourceMode(),this.activate()},w.activate=function(){var a=this;i.activate.call(this),this.active?(this.toolbar.disable(),setTimeout(function(){a.enable()},5)):this.toolbar.enable()},w.execute=function(a){a.preventDefault(),this.toolbar.toggleSourceMode(),c.emitter.emit("click change toggle")},c.range=x(),c.sanitizer=function(a,b){return typeof html_sanitizer=="undefined"?a:html_sanitizer.sanitizeWithPolicy(a,c.sanitizer.policies[b])},c.sanitizer.policies={paste:function(a,b){if(c.sanitizer.paste_elements.indexOf(a)!==-1)return html_sanitizer.sanitizeAttribs(a,b,c.sanitizer.policies.uri)},uri:function(a){return a},tokens:function(a){return null}},c.sanitizer.paste_elements=c.whitelist,a.fizzywig=c})(window);
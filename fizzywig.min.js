(function(a,b){function d(){var a={},b={};return a.on=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){b[a]=b[a]||[],b[a].indexOf(d)===-1&&b[a].push(d)}),a},a.off=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){if(b[a]){var c=b[a].indexOf(d);b[a]=b[a].slice(0,c).concat(b[a].slice(c+1))}}),a},a.emit=function(a,c){a=a.split(/\s+/),c=c||[];var d={};return a.forEach(function(a){b[a]&&(d[a]=[],b[a].forEach(function(b){d[a].push(b.apply(this,c))}))}),d},a.clear=function(){return b={},a},a}function e(a,b){var d={},e,f,h;return typeof a=="string"?e=document.querySelector(a):a instanceof Element&&(e=a),f=e.querySelectorAll("[data-content-editor-command]"),f=Array.prototype.map.apply(f,[function(a){return g(a,d)}]).filter(function(a){return!!a}),d.enable=function(){return f.forEach(function(a){a.enable()}),d},d.disable=function(){return d},d.toggleSourceMode=function(){b.toggleSourceMode()},d.isSourceMode=function(){return b.isSourceMode()},c.emitter.on("focus",function(){h=!0,d.enable()}),c.emitter.on("blur",function(a){h=!1,setTimeout(function(){h||d.disable()},150)}),c.emitter.on("click",function(){h=!0}),d.disable()}function f(){document.querySelector("[contenteditable]").focus()}function g(a,b){var c,d,e,f,g;d=a.getAttribute("data-content-editor-command"),e=a.getAttribute("data-content-editor-value"),f=a.getAttribute("data-content-editor-prompt"),c=e||d;if(h.types.hasOwnProperty(c))return h.create(c,a,d,e,f,b)}function h(a,b,c,d,e){this.node=a,this.command=b,this.value=c,this.prompt=d,this.active=!1,this.toolbar=e,this.nodeTarget=a&&a.nodeName.toLowerCase()==="option"?a.parentElement:a}function k(){h.apply(this,arguments)}function m(){k.apply(this,arguments)}function o(){h.apply(this,arguments)}function q(){h.apply(this,arguments)}function s(){h.apply(this,arguments)}function u(){h.apply(this,arguments)}function w(){h.apply(this,arguments)}function y(b){var c,d={};return a.getSelection?(c=a.getSelection(),c.rangeCount&&(c=c.getRangeAt(0))):document.selection&&(c=document.selection.createRange()),d.is=function(a){return a.toLowerCase()===d.parentNode()},d.parentNode=function(){var b;if(c)return a.getSelection?(b=c.startContainer,b&&b.nodeType===3&&(b=b.parentNode),b&&b.nodeName.toLowerCase()):c.parentElement().nodeName.toLowerCase()},d.restore=function(e){if(a.getSelection){var f=a.getSelection();b.focus();if(c.collapsed){var g=document.createTextNode("\0");c.insertNode(g),c.selectNode(g),c.collapse(!1)}f.removeAllRanges(),f.addRange(c);if(e){var h=document.createRange(),i=d.commonAncestor();i!==b&&(h.selectNode(i),f.removeAllRanges(),f.addRange(h))}}else document.selection&&c.select&&c.select()},d.commonAncestor=function(){var b;return a.getSelection?(b=c.commonAncestorContainer,b&&b.nodeType===3&&(b=b.parentNode)):document.selection&&(b=c.parentElement()),b},d.selectNode=function(b){var c=document.createRange(),d=a.getSelection();d.removeAllRanges(),c.selectNode(b),d.addRange(c)},d.moveToEnd=function(b){var c,d;document.createRange?(c=document.createRange(),c.selectNodeContents(b),c.collapse(!1),d=a.getSelection(),d.removeAllRanges(),d.addRange(c)):document.selection&&(c=document.createTextRange(),c.moveToElementText(b),c.collapse(!1),c.select())},d.wrap=function(a){var b;try{b=document.createElement(a),c.surroundContents(b),d.selectNode(b)}catch(e){}},d.insertHTML=function(a){if(c&&c.pasteHTML)c.pasteHTML(a);else{var b=document.createElement("div"),d=document.createDocumentFragment(),e,f;b.innerHTML=a;while(e=b.firstChild)f=d.appendChild(e);c.insertNode(d)}},d}function z(a,b,c,d){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.addEventListener(b,D.apply(this,[c]),d||!1):a.attachEvent&&a.attachEvent("on"+b,D.apply(this,[c]))})}function A(a,b,c){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.removeEventListener(b,D.apply(this,[c])):a.attachEvent&&a.detachEvent("on"+b,D.apply(this,[c]))})}function B(a,b){var c=a.className.split(/\s+/);c.indexOf(b)===-1&&c.push(b),a.className=c.join(" ")}function C(a,b){var c=a.className.split(/\s+/),d=c.indexOf(b);d!==-1&&(c=c.slice(0,d).concat(c.slice(d+1))),a.className=c.join(" ")}function D(b){return function(c){c||(c=a.event);if(!("defaultPrevented"in c)){c.defaultPrevented=!1;var d=c.preventDefault;c.preventDefault=function(){this.defaultPrevented=!0,this.returnValue=!1,d&&d.call(this)}}c.target=c.target||c.srcElement,c.which=c.keyCode||c.charCode,b.apply(this,[c])}}var c;c={version:"0.0.1",block_elements:["p","pre","Normal","Preformatted"],inline_elements:["b","i","strong","em","a","del","strike"],void_elements:["img","br","hr"],whitelist:["a","abbr","acronym","address","area","b","bdo","big","blockquote","br","caption","center","cite","code","colgroup","dd","del","dfn","dir","div","dl","dt","em","embed","font","h1","h2","h3","h4","h5","h6","hr","i","img","ins","kbd","li","map","menu","object","ol","p","param","pre","q","s","samp","small","span","strike","strong","sub","sup","table","tbody","td","tfoot","th","thead","tr","tt","u","ul","var"]},[1,2,3,4,5,6].forEach(function(a){c.block_elements.push("Heading "+a),c.block_elements.push("h"+a)}),c.emitter=d(),c.content=function(a){function l(a){c.selection=rangy.getSelection(),c.range=c.selection.rangeCount&&c.selection.getRangeAt(0),m(a)}function m(a){a.which===8&&!(d.innerText||d.textContent||"").trim()&&(a.preventDefault(),d.innerHTML="<p><br></p>");try{var b=c.range.commonAncestorContainer;(!b||(b.nodeType===3||b.nodeName==="DIV")&&b.parentNode===d)&&document.execCommand("formatBlock",!1,"<p>")}catch(a){}}function n(a){setTimeout(function(){d.innerHTML=c.sanitizer(d.innerHTML,"paste")},1)}function o(a){c.emitter.emit(a.type,[a])}function p(a,b){var c;return function(){function f(){a.apply(e,d),c=null}var d=arguments,e=this;clearTimeout(c),c=setTimeout(f,b)}}function q(){if(g)return;var a=b.json();JSON.stringify(h)!==JSON.stringify(a)&&(c.emitter.emit("dirty"),g=setTimeout(function(){c.emitter.emit("save",[h=b.json()]),g=null},2e3))}var b={},d,f,g,h={},i,j,k;return c.emitter.clear(),typeof a=="string"?d=document.querySelector(a):a instanceof Node&&(d=a),i=d.getAttribute("data-content-editable")||"data",k=document.createElement("textarea"),k.setAttribute("style","display:none;"),k.setAttribute("class","fizzy-raw"),d.parentNode.insertBefore(k,d.nextSibling),b.toolbar=function(a){return arguments.length?(f=e(a,b),b):f},b.enable=function(){d.setAttribute("contentEditable",!0);try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBROnReturn",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(a){}return b},b.disable=function(){return d.removeAttribute("contentEditable"),b},b.moveToEnd=function(){c.selection=rangy.getSelection(),c.range=rangy.createRange(),c.range.selectNodeContents(d),c.range.collapse(!1),c.selection.setSingleRange(c.range)},b.json=function(){var a={};return a[i]=(d.innerHTML||"").trim(),a},b.tidy=function(a){b.isSourceMode()&&b.toggleSourceMode(),b.sanitize()},b.toggleSourceMode=function(){if(b.isSourceMode())d.innerHTML=c.sanitizer(k.value.trim(),"paste"),k.style.display="none",d.style.display="block",c.emitter.emit("sanitize:preview",[d]);else{var a=d.innerHTML.trim(),e=c.emitter.emit("sanitize:source",[a]);k.value=c.sanitizer(e["sanitize:source"]&&e["sanitize:source"][0]||a,"paste"),d.style.display="none",k.style.display="block"}},b.isSourceMode=function(){return k.style.display!=="none"},b.sanitize=function(){b.isSourceMode()?d.innerHTML=c.sanitizer(d.innerHTML.trim(),"paste"):k.value=c.sanitizer(k.value.trim(),"paste")},c.emitter.on("keyup change blur paste",q),b.on=c.emitter.on,z(d,"focus blur keyup mouseup paste change",p(o,50)),z(d,"focus blur keyup mouseup paste change",p(l,50)),z(d,"paste",n),b.enable()},h.types={insertimage:u,createlink:s,code:q,"<pre>":k,"<p>":m,togglehtml:w};var i=7;while(--i)h.types["<h"+i+">"]=k;["insertunorderedlist","insertorderedlist","bold","italic","strikethrough","underline","indent","outdent"].forEach(function(a){h.types[a]=o}),h.create=function(a,b,c,d,e,f){var g=new h.types[a](b,c,d,e,f);return g.init()};var j=h.prototype;j.init=function(){var a=this;return c.emitter.on("keyup mouseup paste change",function(){a.check()}),z(this.nodeTarget,"blur",h.emit("blur")),z(this.nodeTarget,"focus",h.emit("focus")),this.isChild()?z(this.nodeTarget,"change",function(b){a.execute(b)}):z(this.node,"click",function(b){a.execute(b)}),this},j.isChild=function(){return this.node!==this.nodeTarget},j.enable=function(){this.nodeTarget.removeAttribute("disabled")},j.disable=function(){this.nodeTarget.setAttribute("disabled","disabled")},j.activate=function(){this.active?(B(this.nodeTarget,"active"),this.isChild()&&this.node.setAttribute("selected","selected")):(C(this.nodeTarget,"active"),this.isChild()&&this.node.removeAttribute("selected"))},h.emit=function(a){return function(b){c.emitter.emit(a)}},h.block_normalization={normal:"p",heading:"h"},h.block_regexp=/(heading|normal)\s*/i,h.normalizeCommandValue=function(a){return h.block_regexp.test(a)&&(a=a.replace(h.block_regexp,function(a){return h.block_normalization[a.trim().toLowerCase()]})),"<"+a+">"};var l=k.prototype=new h;l.constructor=k,l.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=h.normalizeCommandValue(a),this.active=this.value===a,this.activate()},l.execute=function(a){a.preventDefault(),this.isChild()&&this.nodeTarget.value===this.node.value&&(f(!0),document.execCommand(this.command,!1,this.value),c.emitter.emit("click change"))};var n=m.prototype=new k;n.constructor=m,n.check=function(){var a,b;try{a=document.queryCommandValue(this.command),b=document.queryCommandState("insertunorderedlist")||document.queryCommandState("insertorderedlist")}catch(c){}a=h.normalizeCommandValue(a),this.active=this.value===a||b,this.activate()};var p=o.prototype=new h;p.constructor=o,p.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},p.execute=function(a){a.preventDefault(),f(),["insertunorderedlist","insertorderedlist"].indexOf(this.command)!==-1&&document.execCommand("formatBlock",!1,"<p>"),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var r=q.prototype=new h;r.constructor=q,r.check=function(){var a,b;try{b=c.range.commonAncestorContainer,a=b&&(b.nodeType===3&&b.parentNode&&b.parentNode.nodeName===this.command.toUpperCase()||b.nodeType===1&&b.nodeName===this.command.toUpperCase())}catch(d){}this.active=a,this.activate()},r.execute=function(a){a.preventDefault();var b,d;f(),this.check(),this.active?(b=c.range.commonAncestorContainer,b.nodeType===3&&b.parentNode.nodeName==="CODE"?d=b.parentNode:b.nodeType===1&&b.nodeName==="CODE"&&(d=b),c.range.selectNode(d),document.execCommand("removeFormat",!1,null)):c.range&&c.range.canSurroundContents()&&(d=document.createElement(this.command),c.range.surroundContents(d)),c.emitter.emit("click change")};var t=s.prototype=new h;t.constructor=s,t.check=function(){var a,b;try{a=c.range.commonAncestorContainer,b=a&&(a.nodeType===3&&a.parentNode&&a.parentNode.nodeName==="A"||a.nodeType===1&&a.nodeName==="A")}catch(d){}this.active=b,this.activate()},t.execute=function(a){a.preventDefault(),f();if(this.active)document.execCommand("unlink",!1,null);else{var b=c.emitter.emit(this.prompt);b[this.prompt]&&document.execCommand(this.command,!1,b[this.prompt][0])}c.emitter.emit("click change")};var v=u.prototype=new h;v.constructor=u,v.check=function(){},v.execute=function(a){a.preventDefault(),f(),c.emitter.emit(this.prompt,[c.range]),c.emitter.emit("click change")};var x=w.prototype=new h;x.constructor=w,x.check=function(){this.active=this.toolbar.isSourceMode(),this.activate()},x.activate=function(){var a=this;j.activate.call(this),this.active?(this.toolbar.disable(),setTimeout(function(){a.enable()},5)):this.toolbar.enable()},x.execute=function(a){a.preventDefault(),this.toolbar.toggleSourceMode(),c.emitter.emit("click change toggle")},c.sanitizer=function(a,b){return typeof html_sanitizer=="undefined"?a:html_sanitizer.sanitizeWithPolicy(a,c.sanitizer.policies[b])},c.sanitizer.policies={paste:function(a,b){if(c.sanitizer.paste_elements.indexOf(a)!==-1)return html_sanitizer.sanitizeAttribs(a,b,c.sanitizer.policies.uri)},uri:function(a){return a},tokens:function(a){return null}},c.sanitizer.paste_elements=c.whitelist,a.fizzywig=c})(window);
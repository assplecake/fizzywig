(function(a,b){function d(){var a={},b={};return a.on=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){b[a]=b[a]||[],b[a].indexOf(d)===-1&&b[a].push(d)}),a},a.off=function(c,d){return c=c.split(/\s+/),c.forEach(function(a){if(b[a]){var c=b[a].indexOf(d);b[a]=b[a].slice(0,c).concat(b[a].slice(c+1))}}),a},a.emit=function(a,c){a=a.split(/\s+/),c=c||[];var d={};return a.forEach(function(a){b[a]&&(d[a]=[],b[a].forEach(function(b){d[a].push(b.apply(this,c))}))}),d},a.clear=function(){return b={},a},a}function e(a,b){var d={},e,f,h;return typeof a=="string"?e=document.querySelector(a):a instanceof Element&&(e=a),f=e.querySelectorAll("[data-content-editor-command]"),f=Array.prototype.map.apply(f,[function(a){return g(a,d)}]).filter(function(a){return!!a}),d.enable=function(){return f.forEach(function(a){a.enable()}),d},d.disable=function(){return f.forEach(function(a){a.disable()}),d},d.toggleSourceMode=function(){b.toggleSourceMode()},d.isSourceMode=function(){return b.isSourceMode()},c.emitter.on("focus",function(){h=!0,d.enable()}),c.emitter.on("blur",function(a){h=!1,setTimeout(function(){h||d.disable()},150)}),c.emitter.on("click",function(){h=!0}),d.disable()}function f(a,b){function h(b){c.range=y(a)}function i(b){D(a,"fizzy-hover")}function j(b){E(a,"fizzy-hover")}function k(a){if(c.block_elements.indexOf(document.queryCommandValue("formatBlock"))===-1){var b=c.range.commonAncestor();(!b||b.nodeName.toLowerCase()==="div")&&document.execCommand("formatBlock",!1,"<p>")}}function l(b){setTimeout(function(){a.innerHTML=c.sanitizer(a.innerHTML,"paste")},1)}function m(a){c.emitter.emit(a.type,[a])}var d={},e,f,g;return e=a.getAttribute("data-content-editable")||"data",g=document.createElement("textarea"),g.setAttribute("style","display:none;"),g.setAttribute("class","fizzy-raw"),a.parentNode.insertBefore(g,a.nextSibling),d.enable=function(){return a.setAttribute("contentEditable",!0),d},d.disable=function(){return a.removeAttribute("contentEditable"),d},d.focus=function(){return D(a,"fizzy-active"),d},d.blur=function(){return E(a,"fizzy-active"),d},d.moveToEnd=function(){c.range=y(a),c.range.moveToEnd(a)},d.json=function(){var b={};return A(b,e,(a.innerHTML||"").trim()),b},d.tidy=function(b){b(a),d.sanitize()},d.toggleSourceMode=function(){d.isSourceMode()?(a.innerHTML=g.value.trim(),g.style.display="none",a.style.display="block",c.emitter.emit("toggle:preview",[a])):(g.value=a.innerHTML.trim(),a.style.display="none",g.style.display="block",c.emitter.emit("toggle:source",[g]))},d.isSourceMode=function(){return g.style.display!=="none"},d.sanitize=function(){d.isSourceMode()?a.innerHTML=c.sanitizer(a.innerHTML.trim(),"paste"):g.value=c.sanitizer(g.value.trim(),"paste")},B(a,"focus blur keyup mouseup paste change",m),B(a,"focus blur keyup mouseup paste change",h),B(a,"keydown",k),B(a,"paste",l),B(a,"mouseover",i),B(a,"mouseout",j),d.enable()}function g(a,b){var c,d,e,f,g;d=a.getAttribute("data-content-editor-command"),e=a.getAttribute("data-content-editor-value"),f=a.getAttribute("data-content-editor-prompt"),c=e||d;if(h.types.hasOwnProperty(c))return h.create(c,a,d,e,f,b)}function h(a,b,c,d,e){this.node=a,this.command=b,this.value=c,this.prompt=d,this.active=!1,this.toolbar=e,this.nodeTarget=a&&a.nodeName.toLowerCase()==="option"?a.parentElement:a}function k(){h.apply(this,arguments)}function m(){h.apply(this,arguments)}function o(){h.apply(this,arguments)}function q(){h.apply(this,arguments)}function s(){h.apply(this,arguments)}function u(){h.apply(this,arguments)}function w(){h.apply(this,arguments)}function y(b){var c,d={};return a.getSelection?(c=a.getSelection(),c.rangeCount&&(c=c.getRangeAt(0))):document.selection&&(c=document.selection.createRange()),d.is=function(a){return a.toLowerCase()===d.parentNode()},d.parentNode=function(){var b;if(c)return a.getSelection?(b=c.startContainer,b&&b.nodeType===3&&(b=b.parentNode),b&&b.nodeName.toLowerCase()):c.parentElement().nodeName.toLowerCase()},d.restore=function(b){if(a.getSelection){var e=a.getSelection();if(c.collapsed){var f=document.createTextNode("\0");c.insertNode(f),c.selectNode(f)}e.removeAllRanges(),e.addRange(c);if(b){var g=document.createRange(),h=d.commonAncestor();g.selectNode(h),e.addRange(g)}}else document.selection&&c.select&&c.select()},d.commonAncestor=function(){var b;return a.getSelection?(b=c.commonAncestorContainer,b&&b.nodeType===3&&(b=b.parentNode)):document.selection&&(b=c.parentElement()),b},d.selectNode=function(b){var c=document.createRange(),d=a.getSelection();d.removeAllRanges(),c.selectNode(b),d.addRange(c)},d.moveToEnd=function(b){var c,d;document.createRange?(c=document.createRange(),c.selectNodeContents(b),c.collapse(!1),d=a.getSelection(),d.removeAllRanges(),d.addRange(c)):document.selection&&(c=document.createTextRange(),c.moveToElementText(b),c.collapse(!1),c.select())},d.wrap=function(a){var b;try{b=document.createElement(a),c.surroundContents(b),d.selectNode(b)}catch(e){}},d.insertHTML=function(a){if(c&&c.pasteHTML)c.pasteHTML(a);else{var b=document.createElement("div"),d=document.createDocumentFragment(),e,f;b.innerHTML=a;while(e=b.firstChild)f=d.appendChild(e);c.insertNode(d)}},d}function z(){var a=Array.prototype.slice.apply(arguments);return a.reduce(function(a,b){return Object.keys(b).forEach(function(c){a[c]&&a[c].constructor===Object&&b[c].constructor===Object?z(a[c],b[c]):a[c]=b[c]}),a})}function A(a,b,c){function d(a,b,c,d){return a[b]}function e(a,b,d,e){return d===e.length-1?a[b]=c:a[b]||(a[b]={})}return typeof b=="string"&&(b=b.split(".")),b.reduce(typeof c=="undefined"?d:e,a)}function B(a,b,c,d){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.addEventListener(b,F.apply(this,[c]),d||!1):a.attachEvent&&a.attachEvent("on"+b,F.apply(this,[c]))})}function C(a,b,c){b=b.split(/\s+/),b.forEach(function(b){a.addEventListener?a.removeEventListener(b,F.apply(this,[c])):a.attachEvent&&a.detachEvent("on"+b,F.apply(this,[c]))})}function D(a,b){var c=a.className.split(/\s+/);c.indexOf(b)===-1&&c.push(b),a.className=c.join(" ")}function E(a,b){var c=a.className.split(/\s+/),d=c.indexOf(b);d!==-1&&(c=c.slice(0,d).concat(c.slice(d+1))),a.className=c.join(" ")}function F(b){return function(c){c||(c=a.event);if(!("defaultPrevented"in c)){c.defaultPrevented=!1;var d=c.preventDefault;c.preventDefault=function(){this.defaultPrevented=!0,this.returnValue=!1,d&&d.call(this)}}c.target=c.target||c.srcElement,c.which=c.keyCode||c.charCode,b.apply(this,[c])}}var c;c={version:"0.0.1",block_elements:["p","pre","Normal","Preformatted"],inline_elements:["b","i","strong","em","a","del","strike"],void_elements:["img","br","hr"]},[1,2,3,4,5,6].forEach(function(a){c.block_elements.push("Heading "+a),c.block_elements.push("h"+a)}),c.emitter=d(),c.content=function(a){function k(){if(i)return;var a=b.json();JSON.stringify(j)!==JSON.stringify(a)&&(c.emitter.emit("dirty"),i=setTimeout(function(){c.emitter.emit("save",[j=b.json()]),i=null},2e3))}var b={},d,g,h,i,j={};c.emitter.clear();if(typeof a=="string")d=document.querySelectorAll(a);else if(a instanceof NodeList||Array.isArray(a))d=a;return d=Array.prototype.map.apply(d,[function(a){return f(a,b)}]),b.toolbar=function(a){return arguments.length?(g=e(a,b),b):g},b.enable=function(){d.forEach(function(a){a.enable()});try{document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBROnReturn",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("enableObjectResizing",!1,!1)}catch(a){}return b},b.disable=function(){return d.forEach(function(a){a.disable()}),b},b.focus=function(){return d.forEach(function(a){a.focus()}),b},b.blur=function(){return d.forEach(function(a){a.blur()}),b},b.moveToEnd=function(){d[0].moveToEnd()},b.json=function(){var a={},b=d.map(function(a){return a.json()});return b.unshift(a),z.apply(null,b),a},b.tidy=function(a){b.isSourceMode()&&b.toggleSourceMode(),d.forEach(function(b){b.tidy(a)})},b.toggleSourceMode=function(){d.forEach(function(a){a.toggleSourceMode()})},b.isSourceMode=function(){return d.some(function(a){return a.isSourceMode()})},b.sanitize=function(){d.forEach(function(a){a.sanitize()})},c.emitter.on("keyup change blur paste",k),c.emitter.on("focus",function(){b.focus()}),c.emitter.on("blur",function(){b.blur()}),b.on=c.emitter.on,b.enable()},h.types={insertimage:s,createlink:q,code:o,"<pre>":k,"<p>":k,togglehtml:w};var i=7;while(--i)h.types["<h"+i+">"]=k;["insertunorderedlist","insertorderedlist","bold","italic","strikethrough","underline","indent","outdent"].forEach(function(a){h.types[a]=m}),h.create=function(a,b,c,d,e,f){var g=new h.types[a](b,c,d,e,f);return g.init()};var j=h.prototype;j.init=function(){var a=this;return c.emitter.on("keyup mouseup paste change",function(){a.check()}),B(this.nodeTarget,"blur",h.emit("blur")),B(this.nodeTarget,"focus",h.emit("focus")),this.isChild()?B(this.nodeTarget,"change",function(b){a.execute(b)}):B(this.node,"click",function(b){a.execute(b)}),this},j.isChild=function(){return this.node!==this.nodeTarget},j.enable=function(){this.nodeTarget.removeAttribute("disabled")},j.disable=function(){this.nodeTarget.setAttribute("disabled","disabled")},j.activate=function(){this.active?(D(this.nodeTarget,"active"),this.isChild()&&this.node.setAttribute("selected","selected")):(E(this.nodeTarget,"active"),this.isChild()&&this.node.removeAttribute("selected"))},h.emit=function(a){return function(b){c.emitter.emit(a)}},h.block_normalization={normal:"p",heading:"h"},h.block_regexp=/(heading|normal)\s*/i,h.normalizeCommandValue=function(a){return h.block_regexp.test(a)&&(a=a.replace(h.block_regexp,function(a){return h.block_normalization[a.trim().toLowerCase()]})),"<"+a+">"};var l=k.prototype=new h;l.constructor=k,l.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=h.normalizeCommandValue(a),this.active=this.value===a,this.activate()},l.execute=function(a){a.preventDefault(),this.isChild()&&this.nodeTarget.value===this.node.value&&(c.range.restore(!0),document.execCommand(this.command,!1,this.value),c.emitter.emit("click change"))};var n=m.prototype=new h;n.constructor=m,n.check=function(){var a;try{a=document.queryCommandState(this.command)}catch(b){}this.active=a,this.activate()},n.execute=function(a){a.preventDefault(),c.range.restore(),document.execCommand(this.command,!1,null),c.emitter.emit("click change")};var p=o.prototype=new h;p.constructor=o,p.check=function(){var a;try{a=c.range.is(this.command)}catch(b){}this.active=a,this.activate()},p.execute=function(a){a.preventDefault(),c.range.restore(),this.check(),this.active?document.execCommand("removeFormat",!1,null):c.range.wrap(this.command),c.emitter.emit("click change")};var r=q.prototype=new h;r.constructor=q,r.check=function(){this.active=c.range.is("a"),this.activate()},r.execute=function(a){a.preventDefault(),c.range.restore();if(this.active)document.execCommand("unlink",!1,null);else{var b=c.emitter.emit(this.prompt);b[this.prompt]&&document.execCommand(this.command,!1,b[this.prompt][0])}c.emitter.emit("click change")};var t=s.prototype=new h;t.constructor=s,t.check=function(){},t.execute=function(a){a.preventDefault(),c.range.restore(),c.emitter.emit(this.prompt,[c.range]),c.emitter.emit("click change")};var v=u.prototype=new h;t.constructor=u,v.check=function(){var a;try{a=document.queryCommandValue(this.command)}catch(b){}a=h.normalizeCommandValue(a),this.active=this.value===a,this.activate()},v.execute=function(a){a.preventDefault();var b=this.active?"<p>":this.value;c.range.restore(!0),document.execCommand(this.command,!1,b),c.emitter.emit("click change")};var x=w.prototype=new h;x.constructor=w,x.check=function(){this.active=this.toolbar.isSourceMode(),this.activate()},x.activate=function(){var a=this;j.activate.call(this),this.active?(this.toolbar.disable(),setTimeout(function(){a.enable()},5)):this.toolbar.enable()},x.execute=function(a){a.preventDefault(),this.toolbar.toggleSourceMode(),c.emitter.emit("click change toggle")},c.sanitizer=function(a,b){return typeof html_sanitizer=="undefined"?a:html_sanitizer.sanitizeWithPolicy(a,c.sanitizer.policies[b])},c.sanitizer.policies={paste:function(a,b){if(c.sanitizer.paste_elements.indexOf(a)!==-1)return html_sanitizer.sanitizeAttribs(a,b,c.sanitizer.policies.uri,c.sanitizer.policies.tokens)},uri:function(a){return a},tokens:function(a){return null}},c.sanitizer.paste_elements=c.block_elements.concat(c.inline_elements,c.void_elements),a.fizzywig=c})(window);